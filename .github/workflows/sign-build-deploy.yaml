name: Sign, build, and deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version of the artifact to deploy
        required: true
        default: 8.0.0.7
permissions:
  id-token: write
  contents: read

env:
  ARTIFACT_NAME: aerospike-server
  AWS_ROLE: arn:aws:iam::360255567471:role/sso/assumed/iac/AerospikeDownloadArtifactsAutomation
  JFROG_PROJECT: database
  JFROG_URL: https://aerospike.jfrog.io
  ORG: citrusleaf
  S3_BUCKET: aerospike-qe-build

jobs:
  download-sign-deploy:
    if: ${{ github.repository_owner == 'citrusleaf' }}
    runs-on: ubuntu-22.04  # v24.04 is not supported by artifact signing action
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0

      - name: Setup JFrog CLI
        uses: step-security/setup-jfrog-cli@a6b41f8338bea0983ddff6bd4ede7d2dcd81e1fa # v4.8.1
        env:
          JF_URL: ${{ env.JFROG_URL }}
          JF_PROJECT: ${{ env.JFROG_PROJECT }}
        with:
          oidc-provider-name: gh-citrusleaf
          oidc-audience: citrusleaf

      - name: Check JFrog Configuration 
        run: |
          jf c show
          jf rt ping

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502  # v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          role-session-name: aerospike-download-artifacts
          aws-region: us-west-1

      - name: Download artifacts from QE server
        run: |
          mkdir -p build-artifacts
          echo "Listing build directory:"
          aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.ORG }}/${{ env.ARTIFACT_NAME }}/${{ github.event.inputs.version }}/build/

          # Getting debs and rpms from QE server
          files=$(aws s3 ls s3://${{ env.S3_BUCKET }}/${{ env.ORG }}/${{ env.ARTIFACT_NAME }}/${{ github.event.inputs.version }}/build/ --recursive | 
                  awk '{print $4}' | 
                  grep -E -- 'deb$|rpm$')

          # Use parallel to download files with strict error handling
          echo "$files" | parallel --will-cite --halt-on-error 1 -j 0 \
              "aws s3 cp --no-progress s3://${{ env.S3_BUCKET }}/{} build-artifacts/"

      - name: List downloaded files
        run: find build-artifacts

      - name: Setup GPG
        uses: aerospike/shared-workflows/.github/actions/setup-gpg@dda8173aca1f1e73f95267572a7d3849cd00f1b8  # v1.0.0
        with:
          gpg-private-key: ${{ secrets.GPG_SECRET_KEY }}
          gpg-public-key: ${{ secrets.GPG_PUBLIC_KEY }}
          gpg-key-pass: ${{ secrets.GPG_PASS }}

      - name: Install dpkg-sig
        run: sudo apt-get update && sudo apt-get install dpkg-sig dpkg-dev -y

      - name: Structure downloaded files
        run: |
          source .github/bin/package_utils.sh
          mkdir -p structured_release

          # Process all RPMs
          for rpm in ./build-artifacts/*.rpm; do
            if [ -f "$rpm" ]; then
              echo "Processing RPM: $rpm"
              process_rpm "$rpm" "./structured_release"
            fi
          done

          # Process all DEBs
          for deb in ./build-artifacts/*.deb; do
            if [ -f "$deb" ]; then
              echo "Processing DEB: $deb"
              process_deb "$deb" "./structured_release"
            fi
          done

      - name: Sign DEB packages
        env: 
          GPG_TTY: no-tty
          HOME: /home/runner
          GNUPGHOME: /home/runner/.gnupg
        run: |
          source .github/bin/package_utils.sh
          cd structured_release

          find . -name "*.deb" -print0 | while IFS= read -r -d '' deb; do
            echo "Signing $deb"
            # Sign the package
            dpkg-sig --sign builder --gpg-options "--batch --pinentry-mode loopback --passphrase-file $GNUPGHOME/passphrase" "$deb"
            # Verify the signature
            dpkg-sig --verify "$deb"
            # External gpg sign
            gpg --batch --yes --detach-sign --armor --passphrase "${{ secrets.GPG_PASS }}" --local-user aerospike-inc --output "$deb.asc" "$deb"
            cat "$deb.asc" 
          done

      - name: Upload DEB packages to JFrog
        run: |
          source .github/bin/package_utils.sh
          cd ./structured_release/

          find . -name "*.deb" -print0 | while IFS= read -r -d '' deb; do
            # Get package metadata
            pkgname=$(dpkg-deb -f "$deb" Package)
            arch=$(dpkg-deb -f "$deb" Architecture)
            codename=$(get_codename_for_deb "$deb")

            # Upload the DEB
            jf rt upload "$deb" "${{ env.JFROG_PROJECT }}-deb-dev-local" --flat=false \
              --build-name="${{ env.ARTIFACT_NAME }}-deb" \
              --build-number="${{ github.event.inputs.version }}" \
              --project="${{ env.JFROG_PROJECT }}" \
              --target-props "deb.distribution=$codename;deb.component=main;deb.architecture=$arch" \
              --deb "$codename/main/$arch"
            
            # Upload signature
            jf rt upload "$deb.asc" "${{ env.JFROG_PROJECT }}-deb-dev-local" --flat=false \
              --build-name="${{ env.ARTIFACT_NAME }}-deb" \
              --build-number="${{ github.event.inputs.version }}" \
              --project="${{ env.JFROG_PROJECT }}"
          done

          # Publish build info
          jf rt build-collect-env "${{ env.ARTIFACT_NAME }}-deb" "${{ github.event.inputs.version }}" \
            --project="${{ env.JFROG_PROJECT }}"
          jf rt build-add-git "${{ env.ARTIFACT_NAME }}-deb" "${{ github.event.inputs.version }}" \
            --project="${{ env.JFROG_PROJECT }}"
          jf rt build-add-dependencies "${{ env.ARTIFACT_NAME }}-deb" "${{ github.event.inputs.version }}" . \
            --project="${{ env.JFROG_PROJECT }}"
          jf rt build-publish "${{ env.ARTIFACT_NAME }}-deb" "${{ github.event.inputs.version }}" \
            --project="${{ env.JFROG_PROJECT }}"

      - name: Sign RPM packages
        env:
          GPG_TTY: no-tty
        run: |
          cd structured_release
          find . -name "*.rpm" -print0 | while IFS= read -r -d '' rpm; do
            echo "Signing $rpm"
            rpm --addsign "$rpm"
            rpm --checksig "$rpm"
            gpg --batch --no-tty --yes --detach-sign --armor \
              --passphrase "${{ secrets.GPG_PASS }}" \
              --local-user aerospike-inc \
              --output "$rpm.asc" "$rpm"
          done

      - name: Upload RPM packages to JFrog
        run: |
          source .github/bin/package_utils.sh
          cd ./structured_release

          find . -name "*.rpm" -print0 | while IFS= read -r -d '' rpm; do
            # Get metadata using the shared function
            read -r -a metadata < <(get_rpm_metadata "$rpm")
            pkgname="${metadata[0]}"
            version="${metadata[1]}"
            arch="${metadata[2]}"
            dist="${metadata[3]}"
            
            # Upload the RPM
            jf rt upload "$rpm" "${{ env.JFROG_PROJECT }}-rpm-dev-local" --flat=false \
              --build-name="${{ env.ARTIFACT_NAME }}-rpm" \
              --build-number="${{ github.event.inputs.version }}" \
              --project="${{ env.JFROG_PROJECT }}" \
              --target-props "rpm.distribution=$dist;rpm.component=main;rpm.architecture=$arch"
            
            # Upload signature
            jf rt upload "$rpm.asc" "${{ env.JFROG_PROJECT }}-rpm-dev-local" --flat=false \
              --build-name="${{ env.ARTIFACT_NAME }}-rpm" \
              --build-number="${{ github.event.inputs.version }}" \
              --project="${{ env.JFROG_PROJECT }}"
          done

          # Publish build info
          jf rt build-collect-env "${{ env.ARTIFACT_NAME }}-rpm" "${{ github.event.inputs.version }}" \
            --project="${{ env.JFROG_PROJECT }}"
          jf rt build-add-git "${{ env.ARTIFACT_NAME }}-rpm" "${{ github.event.inputs.version }}" \
            --project="${{ env.JFROG_PROJECT }}"
          jf rt build-add-dependencies "${{ env.ARTIFACT_NAME }}-rpm" "${{ github.event.inputs.version }}" . \
            --project="${{ env.JFROG_PROJECT }}"
          jf rt build-publish "${{ env.ARTIFACT_NAME }}-rpm" "${{ github.event.inputs.version }}" \
            --project="${{ env.JFROG_PROJECT }}"

      - name: Create release bundle
        run: |
          echo '{
            "name": "${{ env.ARTIFACT_NAME }}-release-bundle",
            "version": "${{ github.event.inputs.version }}",
            "description": "Release for build version ${{ github.event.inputs.version }}",
            "files": [
              {
                "project": "${{ env.JFROG_PROJECT }}",
                "build": "${{ env.ARTIFACT_NAME }}-rpm/${{ github.event.inputs.version }}"
              }, 
              {
                "project": "${{ env.JFROG_PROJECT }}",
                "build": "${{ env.ARTIFACT_NAME }}-deb/${{ github.event.inputs.version }}"
              }
            ]
          }' > release-bundle-spec.json

          cat release-bundle-spec.json
          jf release-bundle-create "${{ env.ARTIFACT_NAME }}" "${{ github.event.inputs.version }}" \
            --spec release-bundle-spec.json \
            --project="${{ env.JFROG_PROJECT }}" \
            --signing-key="aerospike"